import java.io.*;
import java.net.Socket;
import java.net.SocketException;
import java.net.SocketTimeoutException;
import java.net.UnknownHostException;

public class Lamport extends Thread{
	Socket theServer;
	private static ArrayList<String> lamport;
	private static InputStream input;
    private static OutputStream output;
    private static PrintStream printStream;
    private static InputStreamReader inputStream;
    private static BufferedReader bufferedReader;
    private static String message = null;
	public Lamport(Socket s){
    	theServer = s;	
    }
	public void run(){
		try{
	  		  InputStream input = theServer.getInputStream();
			  OutputStream output = theServer.getOutputStream();
			  PrintStream printStream = new PrintStream(output);
			  InputStreamReader inputStream = new InputStreamReader(input);
			  BufferedReader bufferedReader = new BufferedReader(inputStream);
			  String message = null;
			  message=bufferedReader.readLine();
	  		  while(message!=null){
	  	  			if(message.equals("hello")){
	  	  				  printStream.println(message);
	  	  			}
	  	  			else{
	  	  				String response=processMessage(message);
	  	  				printStream.println(response);
	  	  				message = bufferedReader.readLine();
	  	  				if(Server.wantCS=true){
	  	  					requestCS();
	  	  				}
	  	  			  }
	  			  
	  		  }
		} catch(Exception e){
			System.err.println(e);
		}
		
	}
    private synchronized static void lamport(){
    	Socket[] server = new Socket[Server.numServers];
    	for(int i = 0; i<Server.numServers; i++){
    		if(i!=Server.myPort){
        		try {
    				server[i]=new Socket(Server.addresses.get(i), Server.ports.get(i));
        		} catch (UnknownHostException e) {
    				e.printStackTrace();
        		} catch (IOException e) {
    				//alive = false;
    		  }
    		}
    	}
    	for(int i = 0; i<Server.numServers; i++){
    		if(!checkServer(server[i])){
    			Server.addresses.remove(i);
    			Server.ports.remove(i);
    			Server.numServers--;
    		}
    	}
    }
    private static void requestCS(){
    	String request = String.valueOf(LogicalClock.getClock()) + " " + String.valueOf(Server.ID) + " " + Server.message;
    	printStream.println(request);
    	try {
			message = bufferedReader.readLine();
		} catch (IOException e) {
			e.printStackTrace();
		}
    }
	private static boolean checkServer(Socket server){
		  	  boolean alive = true;
		  	  try {
		  			server.setSoTimeout(100);
		  		} catch (SocketException e2) {
		  			// TODO Auto-generated catch block
		  			e2.printStackTrace();
		  		}
		  	  try {
		  			input = server.getInputStream();
		  	  } catch (IOException e1) {
		  			e1.printStackTrace();
		  		}
		  	  	
		  	    try {
		  			output = server.getOutputStream();
		  		} catch (IOException e1) {
		  			e1.printStackTrace();
		  		}
		  	    printStream = new PrintStream(output);
		  	  	inputStream = new InputStreamReader(input);
		  	  	bufferedReader = new BufferedReader(inputStream);
		  	  	message = null;
		  	    String check = "hello";
		  	  	printStream.println(check);
		      	try {
		  			message = bufferedReader.readLine();
		  		} catch(SocketTimeoutException ste){
		  			alive = false;
		  		} catch (IOException e) {
		  			e.printStackTrace();
		  		}
		      	if(!message.equals("hello"))
		      		alive = false;
		  	    if(alive)
		  			try {
		  				server.setSoTimeout(0);
		  			} catch (SocketException e) {
		  				e.printStackTrace();
		  			}
		  	  return alive;
		    }
}